<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Moodle to GitHub</title>
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css"
      integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk"
      crossorigin="anonymous"
    />
  </head>
  <body style="background-color: #cccc;">
    <div class="container" style="margin-top: 60px;">
      <div class="row">
        <div class="col-6">
          <textarea
            class="form-control rounded-0"
            spellcheck="false"
            id="parrafo"
            rows="20"
          ></textarea>

          <div class="text-center" style="margin: 20px;">
            <div class="row">
              <p style="font-weight: bolder; font-size: x-large;">Carpeta:</p>
              <input type="text" id="carpeta" style="margin-left: 15px;" />
              <button
                type="button"
                class="btn btn-info"
                onclick="convertir()"
                id="botonEnviar"
                style="margin-left: 120px;"
              >
                Convertir
              </button>
            </div>
          </div>
        </div>
        <div class="col-6">
          <div class="row">
            <div class="col-12">
              <textarea
                class="form-control rounded-0"
                spellcheck="false"
                id="respuesta"
                rows="11"
              ></textarea>
            </div>
          </div>
          <br />
          <div class="row">
            <div class="col-12">
              <h3>Archivos:</h3>
              <ol id="listaDeLinks"></ol>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      function convertir() {
        let lineas = document.getElementById("parrafo").value.split("\n");
        let contenido = [];
        let moodleURL = "https://moodleinstitucional.uniandes.edu.co/";
        let respuesta = "";

        lineas.forEach((linea) => {
          let aImprimir = linea;
          let spliteada = linea.split(moodleURL);
          if (spliteada.length > 1) {
            if (spliteada[1].includes("mp3")) {
              let auxiliar1 = spliteada[1].split('">')[0];
              let nombreArchivo = auxiliar1.split("/")[5];

              let linkOriginal =
                "https://moodleinstitucional.uniandes.edu.co/" + auxiliar1;

              let nuevoRecurso = {
                nombre: arreglarNombre(nombreArchivo),
                link: linkOriginal,
              };

              let carpeta = document.getElementById("carpeta").value;
              let nuevoLink =
                "https://raw.githubusercontent.com/DeutschUniandes/moodle/master/" +
                carpeta +
                "/" +
                nuevoRecurso.nombre;

              let aux2 = linea.split('">');
              let parte1 = aux2[0].replace(linkOriginal, nuevoLink);
              let parte2 = aux2[1].replace(nombreArchivo, "Audio.mp3");

              respuesta += parte1 + '">' + parte2;

              contenido.push(nuevoRecurso);
            } else {
              let auxiliar1 = spliteada[1].split('"')[0];
              let auxiliar2 = auxiliar1.split("/");
              let nombreArchivo = auxiliar2[auxiliar2.length - 1];

              console.log("LLEGÓÓ: ", nombreArchivo);

              let linkOriginal =
                "https://moodleinstitucional.uniandes.edu.co/" + auxiliar1;

              let nuevoRecurso = {
                nombre: arreglarNombre(nombreArchivo),
                link: linkOriginal,
              };

              let carpeta = document.getElementById("carpeta").value;
              let nuevoLink =
                "https://raw.githubusercontent.com/DeutschUniandes/moodle/master/" +
                carpeta +
                "/" +
                nuevoRecurso.nombre;

              respuesta += linea.replace(linkOriginal, nuevoLink) + "\n";

              contenido.push(nuevoRecurso);
            }
          } else {
            respuesta += linea + "\n";
          }
        });

        document.getElementById("respuesta").value = respuesta;

        let ol = document.getElementById("listaDeLinks");
        borrarHijos(ol);

        contenido.forEach((recurso) => {
          let tr = document.createElement("li");
          let a = document.createElement("a");
          a.setAttribute("href", recurso.link);
          a.setAttribute("onclick", () =>
            a.setAttribute("style", "color:white")
          );
          a.textContent = recurso.nombre;
          tr.appendChild(a);
          ol.appendChild(tr);
        });
      }

      function arreglarNombre(nombre) {
        nombre = nombre.replace("%20", "");
        nombre = nombre.replace("%C3%BC", "u");
        nombre = nombre.replace("%C3%A4", "a");
        nombre = nombre.replace("%2B%C3%AD", "a");
        nombre = nombre.replace("%C3%B6", "o");
        nombre = nombre.replace("%C3%96", "O");
        nombre = nombre.replace("%C3%96", "O");
        return nombre;
      }

      function borrarHijos(elemento) {
        //e.firstElementChild can be used.
        let child = elemento.lastElementChild;
        while (child) {
          elemento.removeChild(child);
          child = elemento.lastElementChild;
        }
      }
    </script>
  </body>
</html>
